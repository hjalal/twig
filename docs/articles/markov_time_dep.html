<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="twig">
<title>A Tutorial for Time Dependent Markov Model • twig</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="A Tutorial for Time Dependent Markov Model">
<meta property="og:description" content="twig">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">twig</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/decision_tree.html">Decision Tree Herpes Virus Encephalopathy</a>
    <a class="dropdown-item" href="../articles/markov_time_dep.html">A Tutorial for Time Dependent Markov Model</a>
  </div>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://www.dashlab.ca/projects/decision_twig/">DecisionTwig</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/hjalal/twig">GitHub</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/hjalal/twig">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>A Tutorial for Time Dependent Markov Model</h1>
            
      
      
      <div class="d-none name"><code>markov_time_dep.Rmd</code></div>
    </div>

    
    
<p>This vignette is based on our tutorial for time-dependent Markov
models in R published in <em>Medical Decision Making</em>:</p>
<p><em>Alarid-Escudero, F., Krijkamp, E., Enns, E. A., Yang, A., Hunink,
M. M., Pechlivanoglou, P., &amp; Jalal, H. (2023). A tutorial on
time-dependent cohort state-transition models in r using a
cost-effectiveness analysis example. Medical Decision Making, 43(1),
21-41.</em></p>
<p>First, we load <code>twig</code> library</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">200</span><span class="op">)</span> </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">twig</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="twig">Twig<a class="anchor" aria-label="anchor" href="#twig"></a>
</h2>
<div class="section level3">
<h3 id="model-definition">model definition<a class="anchor" aria-label="anchor" href="#model-definition"></a>
</h3>
<p>Then, we define the model’s structure <code>twig</code></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_cycles</span> <span class="op">&lt;-</span> <span class="fl">25</span> <span class="co"># number of cycles</span></span>
<span></span>
<span><span class="va">mytwig</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/twig.html">twig</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="../reference/decisions.html">decisions</a></span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">StandardOfCare</span>, <span class="va">StrategyA</span>, <span class="va">StrategyB</span>, <span class="va">StrategyAB</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># define decisions</span></span>
<span>  <span class="fu"><a href="../reference/states.html">states</a></span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">H</span>, <span class="va">S1</span>, <span class="va">S2</span>, <span class="va">D</span><span class="op">)</span>, <span class="co"># Markov state names</span></span>
<span>         init_probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, <span class="co"># everyone starts at H</span></span>
<span>         max_cycles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n_cycles</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># the cohort can stay in S1 for n_cycles</span></span>
<span>  <span class="fu"><a href="../reference/event.html">event</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">death_event</span>,  <span class="co"># first event is death</span></span>
<span>        options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yes</span>,<span class="va">none</span><span class="op">)</span>, <span class="co"># which 2 options</span></span>
<span>        probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pDie</span>, <span class="va">leftover</span><span class="op">)</span>, <span class="co"># probability function name and its complement</span></span>
<span>        transitions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">D</span>, <span class="va">second_event</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># if death occurs go to D, otherwise, go to the next event (second_event)</span></span>
<span>  <span class="fu"><a href="../reference/event.html">event</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">second_event</span>, <span class="co"># the second event</span></span>
<span>        options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">recover</span>, <span class="va">getsick</span>, <span class="va">progress</span>, <span class="va">none</span><span class="op">)</span>, <span class="co"># has 4 options</span></span>
<span>        probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pRecover</span>, <span class="va">pGetSick</span>, <span class="va">pProgress</span>, <span class="va">leftover</span><span class="op">)</span>, <span class="co"># and 3 named probabilities and a complement </span></span>
<span>        transitions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">H</span>, <span class="va">S1</span>, <span class="va">S2</span>, <span class="va">stay</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># resulting in transitions to H, S1, S2 or else staying in the original state</span></span>
<span>  <span class="fu"><a href="../reference/payoffs.html">payoffs</a></span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cost</span>, <span class="va">utility</span><span class="op">)</span>, <span class="co"># payoff names</span></span>
<span>          discount_rates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.03</span>, <span class="fl">0.03</span><span class="op">)</span><span class="op">)</span> <span class="co"># payoff discount rates</span></span>
<span><span class="co">#&gt; Note: A states layer detected in your twig - treating Twig as a Markov model. </span></span>
<span><span class="co">#&gt;             For a decision tree, make sure to remove the states layer.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="decisiontwig">DecisionTwig<a class="anchor" aria-label="anchor" href="#decisiontwig"></a>
</h3>
<p>In <a href="https://www.dashlab.ca/projects/decision_twig/" class="external-link">DecisionTwig</a>,
this Markov model looks like this: <img src="../reference/figures/markov_twig.png" width="700" alt="Markov"></p>
<p>Next, we create a data frame of random samples from the model input
parameters’ distributions</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">n_sims</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="co"># Create the data.table with n_sim rows of random samples</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  r_HS1         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>,             <span class="co"># Transition rate with beta distribution</span></span>
<span>  r_S1H         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,              <span class="co"># Another transition rate with a different shape</span></span>
<span>  hr_S1         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>, <span class="fl">0.2</span><span class="op">)</span>,      <span class="co"># Hazard ratio, log-normal to allow skewness</span></span>
<span>  hr_S2         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="fl">0.2</span><span class="op">)</span>,     <span class="co"># Higher hazard ratio, same distribution</span></span>
<span></span>
<span>  hr_S1S2_trtB  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">6</span>, <span class="fl">4</span><span class="op">)</span>,              <span class="co"># Hazard ratio under treatment with beta distribution</span></span>
<span></span>
<span>  r_S1S2_scale  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n_sims</span>, shape <span class="op">=</span> <span class="fl">2</span>, rate <span class="op">=</span> <span class="fl">25</span><span class="op">)</span>, <span class="co"># Scale parameter, gamma distribution</span></span>
<span>  r_S1S2_shape  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n_sims</span>, shape <span class="op">=</span> <span class="fl">3</span>, rate <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,  <span class="co"># Shape parameter, gamma distribution</span></span>
<span></span>
<span>  c_H           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">2000</span>, sd <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,   <span class="co"># Annual cost, slight variation for simulation</span></span>
<span>  c_S1          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">4000</span>, sd <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,  <span class="co"># Higher annual cost, slightly varied</span></span>
<span>  c_S2          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">15000</span>, sd <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>, <span class="co"># Large cost with moderate variation</span></span>
<span>  c_D           <span class="op">=</span> <span class="fl">0</span>,                                        <span class="co"># Constant, no variation</span></span>
<span>  c_trtA        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">12000</span>, sd <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>, <span class="co"># Cost of treatment A with small variation</span></span>
<span>  c_trtB        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">13000</span>, sd <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>, <span class="co"># Cost of treatment B</span></span>
<span></span>
<span>  u_H           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span>,                  <span class="co"># Utility close to 1 for Healthy</span></span>
<span>  u_S1          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">7.5</span>, <span class="fl">2.5</span><span class="op">)</span>,               <span class="co"># Utility less than Healthy, beta distribution</span></span>
<span>  u_S2          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,                   <span class="co"># Utility for Sicker</span></span>
<span>  u_D           <span class="op">=</span> <span class="fl">0</span>,                                        <span class="co"># Utility for Dead is constant</span></span>
<span>  u_trtA        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">9.5</span>, <span class="fl">1</span><span class="op">)</span>,                 <span class="co"># Utility with treatment A, close to Healthy</span></span>
<span></span>
<span>  du_HS1        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">0.01</span>, sd <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span>, <span class="co"># Disutility with slight variation</span></span>
<span>  ic_HS1        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">1000</span>, sd <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,   <span class="co"># Cost increase with transition</span></span>
<span>  ic_D          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">2000</span>, sd <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,    <span class="co"># Cost increase when dying</span></span>
<span>  p0_H          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">1</span>, <span class="fl">9</span><span class="op">)</span>                   <span class="co"># Initial probability of being Healthy</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="probability-and-reward-functions">Probability and Reward Functions<a class="anchor" aria-label="anchor" href="#probability-and-reward-functions"></a>
</h2>
<p>Then, we define the probability and reward functions used in the
<code>twig</code> above:</p>
<div class="section level3">
<h3 id="probability-of-recovery">Probability of recovery<a class="anchor" aria-label="anchor" href="#probability-of-recovery"></a>
</h3>
<p>only those who are in S1 can recover</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pRecover</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">r_S1H</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">rRecover</span> <span class="op">&lt;-</span> <span class="va">r_S1H</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S1"</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="../reference/rate2prob.html">rate2prob</a></span><span class="op">(</span><span class="va">rRecover</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="probability-of-getting-sick">Probability of getting sick<a class="anchor" aria-label="anchor" href="#probability-of-getting-sick"></a>
</h3>
<p>Only those who are H can get sick</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pGetSick</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">r_HS1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">rGetSick</span> <span class="op">&lt;-</span> <span class="va">r_HS1</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"H"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/rate2prob.html">rate2prob</a></span><span class="op">(</span><span class="va">rGetSick</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="probability-of-progressing">probability of progressing<a class="anchor" aria-label="anchor" href="#probability-of-progressing"></a>
</h3>
<p>This depends on the state (only those who are in S1 can progress),
the decision (different rates for different decisions), and the
cycle_in_state (number of cycles spent in a state - tunnel state)</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pProgress</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">decision</span>, <span class="va">cycle_in_state</span>,</span>
<span>                      <span class="va">hr_S1S2_trtB</span>, <span class="va">r_S1S2_scale</span>, <span class="va">r_S1S2_shape</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">hr_S1S2</span> <span class="op">&lt;-</span> <span class="va">hr_S1S2_trtB</span> <span class="op">^</span> <span class="op">(</span><span class="va">decision</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"StrategyB"</span>, <span class="st">"StrategyAB"</span><span class="op">)</span><span class="op">)</span> <span class="co"># hazard rate of progression for B or 1 otherwise</span></span>
<span></span>
<span>  <span class="va">r_S1S2_tunnels</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="va">cycle_in_state</span><span class="op">*</span><span class="va">r_S1S2_scale</span><span class="op">)</span><span class="op">^</span><span class="va">r_S1S2_shape</span> <span class="op">-</span> </span>
<span>    <span class="op">(</span><span class="op">(</span><span class="va">cycle_in_state</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">r_S1S2_scale</span><span class="op">)</span><span class="op">^</span><span class="va">r_S1S2_shape</span><span class="op">)</span> <span class="co"># hazard rate based on cycle_in_state (tunnel) which follows a weibull distribution</span></span>
<span></span>
<span>  <span class="co"># only those who are at S1 can progress</span></span>
<span>  <span class="va">rProgress</span> <span class="op">&lt;-</span> <span class="va">r_S1S2_tunnels</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S1"</span><span class="op">)</span> <span class="op">*</span> <span class="va">hr_S1S2</span> </span>
<span></span>
<span>  <span class="fu"><a href="../reference/rate2prob.html">rate2prob</a></span><span class="op">(</span><span class="va">rProgress</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="probability-of-dying">probability of dying<a class="anchor" aria-label="anchor" href="#probability-of-dying"></a>
</h3>
<p>Probabilty of dying depends on age. So, we first extract age-specific
mortality data from a csv file. Then, we define the <code>pDie</code> as
a function of the state (different states have different rates of
death), and the cycles since the simulation start which reflects the
cohort’s age.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_age_init</span> <span class="op">&lt;-</span> <span class="fl">24</span> <span class="co"># starting age </span></span>
<span><span class="va">n_age_max</span>  <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># maximum age of simulation</span></span>
<span></span>
<span><span class="co"># Age-dependent mortality rates </span></span>
<span><span class="va">lt_usa_2015</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"../inst/extdata/LifeTable_USA_Mx_2015.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># choose mortality rates from the </span></span>
<span><span class="va">v_r_mort_by_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">lt_usa_2015</span><span class="op">$</span><span class="va">Total</span><span class="op">[</span><span class="va">lt_usa_2015</span><span class="op">$</span><span class="va">Age</span> <span class="op">&gt;=</span> <span class="va">n_age_init</span> <span class="op">&amp;</span> <span class="va">lt_usa_2015</span><span class="op">$</span><span class="va">Age</span> <span class="op">&lt;</span> <span class="va">n_age_max</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># death depends on the state and age.</span></span>
<span><span class="va">pDie</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">cycle</span>,</span>
<span>                 <span class="va">hr_S1</span>, <span class="va">hr_S2</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_HD</span> <span class="op">&lt;-</span> <span class="va">v_r_mort_by_age</span><span class="op">[</span><span class="va">cycle</span><span class="op">]</span> <span class="co"># get age-specific mortality </span></span>
<span>  <span class="va">rDie</span> <span class="op">&lt;-</span> <span class="va">r_HD</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"H"</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># baseline mortality if healthy</span></span>
<span>          <span class="va">r_HD</span><span class="op">*</span><span class="va">hr_S1</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S1"</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># multiplied by a hazard rate if S1 or </span></span>
<span>          <span class="va">r_HD</span><span class="op">*</span><span class="va">hr_S2</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S2"</span><span class="op">)</span> <span class="co"># S2</span></span>
<span>          <span class="co"># else 0</span></span>
<span>  <span class="fu"><a href="../reference/rate2prob.html">rate2prob</a></span><span class="op">(</span><span class="va">rDie</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cost">Cost<a class="anchor" aria-label="anchor" href="#cost"></a>
</h3>
<p>Cost is a function of the state, decision and whether either event
have occured. The events capture transition costs.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cost</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">decision</span>, <span class="va">second_event</span>, <span class="va">death_event</span>, </span>
<span>                 <span class="va">ic_HS1</span>, <span class="va">ic_D</span>, <span class="va">c_trtA</span>, <span class="va">c_trtB</span>, </span>
<span>                 <span class="va">c_H</span>, <span class="va">c_S1</span>, <span class="va">c_S2</span>, <span class="va">c_D</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># cost of decision is only applied if the state is either S1 or S2</span></span>
<span>  <span class="va">trans_cost_getting_sick</span> <span class="op">&lt;-</span> <span class="va">ic_HS1</span> <span class="op">*</span> <span class="op">(</span><span class="va">second_event</span><span class="op">==</span><span class="st">"getsick"</span><span class="op">)</span> <span class="co"># increase in cost when transitioning from Healthy to Sick</span></span>
<span>  <span class="va">trans_cost_dying</span> <span class="op">&lt;-</span> <span class="va">ic_D</span> <span class="op">*</span> <span class="op">(</span><span class="va">death_event</span><span class="op">==</span><span class="st">"yes"</span><span class="op">)</span> <span class="co"># increase in cost when dying</span></span>
<span>  </span>
<span>  <span class="va">c_decision</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">state</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S1"</span>,<span class="st">"S2"</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span></span>
<span>      <span class="va">c_trtA</span> <span class="op">*</span> <span class="op">(</span><span class="va">decision</span><span class="op">==</span><span class="st">"StrategyA"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="va">c_trtB</span> <span class="op">*</span> <span class="op">(</span><span class="va">decision</span><span class="op">==</span><span class="st">"StrategyB"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">c_trtA</span> <span class="op">+</span> <span class="va">c_trtB</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">decision</span><span class="op">==</span><span class="st">"StrategyAB"</span><span class="op">)</span> </span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># cost of the state is a function of the state</span></span>
<span>  <span class="va">c_state</span> <span class="op">&lt;-</span> <span class="va">c_H</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"H"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">c_S1</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S1"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">c_S2</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S2"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">c_D</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"D"</span><span class="op">)</span> </span>
<span>  <span class="co"># combine both</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">c_decision</span> <span class="op">+</span> <span class="va">c_state</span> <span class="op">+</span> <span class="va">trans_cost_getting_sick</span> <span class="op">+</span> <span class="va">trans_cost_dying</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="utility">Utility<a class="anchor" aria-label="anchor" href="#utility"></a>
</h3>
<p>Similarly, utility depends on the state, decision and only if the
cohort gotsick to apply a transition utility discount for those who make
that transition.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">utility</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">decision</span>, <span class="va">second_event</span>,</span>
<span>                    <span class="va">du_HS1</span>, <span class="va">u_H</span>, <span class="va">u_trtA</span>, <span class="va">u_S1</span>, <span class="va">u_S2</span>, <span class="va">u_D</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">trans_util_getting_sick</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">du_HS1</span> <span class="op">*</span> <span class="op">(</span><span class="va">second_event</span><span class="op">==</span><span class="st">"getsick"</span><span class="op">)</span> <span class="co"># apply a utility discount for those who get sick.</span></span>
<span></span>
<span>  <span class="co"># calcualte state utilities. note that S1 will have utility u_trtA if the decision involves A, and another utility if the decision does not involve A.</span></span>
<span>  <span class="va">u_state</span> <span class="op">&lt;-</span> <span class="va">u_H</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"H"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">u_trtA</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S1"</span> <span class="op">&amp;</span> <span class="va">decision</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"StrategyA"</span>, <span class="st">"StrategyAB"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>             <span class="va">u_S1</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S1"</span> <span class="op">&amp;</span> <span class="va">decision</span> <span class="op"><a href="../reference/grapes-out-grapes.html">%out%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"StrategyA"</span>, <span class="st">"StrategyAB"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">u_S2</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S2"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">u_D</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"D"</span><span class="op">)</span> </span>
<span></span>
<span>  <span class="co"># combine the two utilities.</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">u_state</span> <span class="op">+</span> <span class="va">trans_util_getting_sick</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="running-the-twig">Running the <code>twig</code><a class="anchor" aria-label="anchor" href="#running-the-twig"></a>
</h2>
<p>We can run the model and check the summary results under
<code>results$mean_ev</code> of average costs and utilities across all
probabilistic analyses. The results also returns the individual
simulation results under <code>results$sim_ev</code></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_twig.html">run_twig</a></span><span class="op">(</span>twig_obj <span class="op">=</span> <span class="va">mytwig</span>, params <span class="op">=</span> <span class="va">params</span>, n_cycles <span class="op">=</span> <span class="va">n_cycles</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Checking Twig syntax ....</span></span>
<span><span class="co">#&gt; Twig syntax validation completed successfully.</span></span>
<span><span class="co">#&gt; Preprocessing started...</span></span>
<span><span class="co">#&gt; Preprocessing completed. Starting simulation...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Total time: 4.3 secs</span></span>
<span></span>
<span><span class="va">results</span><span class="op">$</span><span class="va">mean_ev</span></span>
<span><span class="co">#&gt;                 reward</span></span>
<span><span class="co">#&gt; decision              cost  utility</span></span>
<span><span class="co">#&gt;   StandardOfCare  78822.33 13.97446</span></span>
<span><span class="co">#&gt;   StrategyA      149847.07 14.45722</span></span>
<span><span class="co">#&gt;   StrategyB      139737.47 14.34340</span></span>
<span><span class="co">#&gt;   StrategyAB     205182.06 14.88534</span></span></code></pre></div>
<div class="section level3">
<h3 id="parallelization">Parallelization<a class="anchor" aria-label="anchor" href="#parallelization"></a>
</h3>
<p>You can run the same command with parallelization, by setting
<code>parallel = TRUE</code>. This will speed up the simulation by
running each simulation in parallel. [It is commented out here because
testing of the <code>twig</code> package only runs on a single
core.]</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># results &lt;- run_twig(twig_obj = mytwig, params = params, n_cycles = n_cycles, parallel = TRUE)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="incremental-cost-effectiveness-ratio-icer">Incremental Cost-Effectiveness Ratio (ICER)<a class="anchor" aria-label="anchor" href="#incremental-cost-effectiveness-ratio-icer"></a>
</h3>
<p>using the <code>calculate_icers</code> function adapted from the
dampack package, we can retrieve ICER table by passing the rewards
summary table.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calculate_icers.html">calculate_icers</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">mean_ev</span><span class="op">)</span></span>
<span><span class="co">#&gt;                      decision      cost  utility inc_cost inc_utility     ICER status</span></span>
<span><span class="co">#&gt; StandardOfCare StandardOfCare  78822.33 13.97446       NA          NA       NA     ND</span></span>
<span><span class="co">#&gt; StrategyB           StrategyB 139737.47 14.34340       NA          NA       NA     ED</span></span>
<span><span class="co">#&gt; StrategyA           StrategyA 149847.07 14.45722       NA          NA       NA     ED</span></span>
<span><span class="co">#&gt; StrategyAB         StrategyAB 205182.06 14.88534 126359.7   0.9108766 138723.2     ND</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cost-effectiveness-acceptibility-curve-ceac">Cost-Effectiveness Acceptibility Curve (CEAC)<a class="anchor" aria-label="anchor" href="#cost-effectiveness-acceptibility-curve-ceac"></a>
</h3>
<p>Similarly, we can produce the CEAC curve from the simulation results
and specifying a series of willingness to pay (WTP) values.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_ceac.html">plot_ceac</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">sim_ev</span>, wtp_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100000</span>, by <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="markov_time_dep_files/figure-html/unnamed-chunk-13-1.png" width="672">
## Summary This example illustrated the following features of
<code>twig</code> * Markov model * probabilistic anslysis * Multiple
decisions * Multiple states * Multiple sequential events * tunnel states
* cycle-dependency * dependency on prior events in a cycle * transition
rewards * using parallel computations * expected rewards across
probabilistic analyses * ICER * CEAC</p>
<p>In addition, various intermediate objects and computations can be
returned by enabling <code>verbose</code>. To reduce the size of the
returned results, this will only use the first PSA sample. For details
on these objects check the documentations.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://www.dashlab.ca" class="external-link">Hawre Jalal</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
