<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>A Tutorial for Time Dependent Markov Model • twig</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="A Tutorial for Time Dependent Markov Model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">twig</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/decision_tree.html">Decision Tree Herpes Virus Encephalopathy</a></li>
    <li><a class="dropdown-item" href="../articles/markov_time_dep.html">A Tutorial for Time Dependent Markov Model</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://www.dashlab.ca/projects/decision_twig/">DecisionTwig</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/hjalal/twig">GitHub</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/hjalal/twig"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>A Tutorial for Time Dependent Markov Model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/hjalal/twig/blob/HEAD/vignettes/markov_time_dep.Rmd" class="external-link"><code>vignettes/markov_time_dep.Rmd</code></a></small>
      <div class="d-none name"><code>markov_time_dep.Rmd</code></div>
    </div>

    
    
<p>This vignette is based on our tutorial for time-dependent Markov
models in R published in <em>Medical Decision Making</em>:</p>
<p><em>Alarid-Escudero, F., Krijkamp, E., Enns, E. A., Yang, A., Hunink,
M. M., Pechlivanoglou, P., &amp; Jalal, H. (2023). A tutorial on
time-dependent cohort state-transition models in r using a
cost-effectiveness analysis example. Medical Decision Making, 43(1),
21-41.</em></p>
<p>First, we load <code>twig</code> library</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.dashlab.ca/" class="external-link">twig</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="twig">Twig<a class="anchor" aria-label="anchor" href="#twig"></a>
</h2>
<div class="section level3">
<h3 id="model-definition">model definition<a class="anchor" aria-label="anchor" href="#model-definition"></a>
</h3>
<p>Then, we define the model’s structure <code>twig</code></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_cycles</span> <span class="op">&lt;-</span> <span class="fl">25</span> <span class="co"># number of cycles</span></span>
<span></span>
<span><span class="va">mytwig</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/twig.html">twig</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="../reference/decisions.html">decisions</a></span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">StandardOfCare</span>, <span class="va">StrategyA</span>, <span class="va">StrategyB</span>, <span class="va">StrategyAB</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># define decisions</span></span>
<span>  <span class="fu"><a href="../reference/states.html">states</a></span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">H</span>, <span class="va">S1</span>, <span class="va">S2</span>, <span class="va">D</span><span class="op">)</span>, <span class="co"># Markov state names</span></span>
<span>         init_probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, <span class="co"># everyone starts at H</span></span>
<span>         max_cycles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n_cycles</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># the cohort can stay in S1 for n_cycles</span></span>
<span>  <span class="fu"><a href="../reference/event.html">event</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">death_event</span>,  <span class="co"># first event is death</span></span>
<span>        options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yes</span>,<span class="va">none</span><span class="op">)</span>, <span class="co"># which 2 options</span></span>
<span>        probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pDie</span>, <span class="va">leftover</span><span class="op">)</span>, <span class="co"># probability function name and its complement</span></span>
<span>        transitions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">D</span>, <span class="va">second_event</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># if death occurs go to D, otherwise, go to the next event (second_event)</span></span>
<span>  <span class="fu"><a href="../reference/event.html">event</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">second_event</span>, <span class="co"># the second event</span></span>
<span>        options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">recover</span>, <span class="va">getsick</span>, <span class="va">progress</span>, <span class="va">none</span><span class="op">)</span>, <span class="co"># has 4 options</span></span>
<span>        probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pRecover</span>, <span class="va">pGetSick</span>, <span class="va">pProgress</span>, <span class="va">leftover</span><span class="op">)</span>, <span class="co"># and 3 named probabilities and a complement </span></span>
<span>        transitions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">H</span>, <span class="va">S1</span>, <span class="va">S2</span>, <span class="va">stay</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="co"># resulting in transitions to H, S1, S2 or else staying in the original state</span></span>
<span>  <span class="fu"><a href="../reference/payoffs.html">payoffs</a></span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cost</span>, <span class="va">utility</span><span class="op">)</span>, <span class="co"># payoff names</span></span>
<span>          discount_rates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.03</span>, <span class="fl">0.03</span><span class="op">)</span><span class="op">)</span> <span class="co"># payoff discount rates</span></span>
<span><span class="co">#&gt; Note: A states layer detected in your twig - treating Twig as a Markov model. </span></span>
<span><span class="co">#&gt;             For a decision tree, make sure to remove the states layer.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="decisiontwig">DecisionTwig<a class="anchor" aria-label="anchor" href="#decisiontwig"></a>
</h3>
<p>In <a href="https://www.dashlab.ca/projects/decision_twig/" class="external-link">DecisionTwig</a>,
this Markov model looks like this: <img src="../reference/figures/markov_twig.png" width="700" alt="Markov"></p>
<p>Next, we create a data frame of random samples from the model input
parameters’ distributions</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">n_sims</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="co"># Create the data.table with n_sim rows of random samples</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  r_HS1         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>,             <span class="co"># Transition rate with beta distribution</span></span>
<span>  r_S1H         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,              <span class="co"># Another transition rate with a different shape</span></span>
<span>  hr_S1         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>, <span class="fl">0.2</span><span class="op">)</span>,      <span class="co"># Hazard ratio, log-normal to allow skewness</span></span>
<span>  hr_S2         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="fl">0.2</span><span class="op">)</span>,     <span class="co"># Higher hazard ratio, same distribution</span></span>
<span></span>
<span>  hr_S1S2_trtB  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">6</span>, <span class="fl">4</span><span class="op">)</span>,              <span class="co"># Hazard ratio under treatment with beta distribution</span></span>
<span></span>
<span>  r_S1S2_scale  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n_sims</span>, shape <span class="op">=</span> <span class="fl">2</span>, rate <span class="op">=</span> <span class="fl">25</span><span class="op">)</span>, <span class="co"># Scale parameter, gamma distribution</span></span>
<span>  r_S1S2_shape  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="va">n_sims</span>, shape <span class="op">=</span> <span class="fl">3</span>, rate <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,  <span class="co"># Shape parameter, gamma distribution</span></span>
<span></span>
<span>  c_H           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">2000</span>, sd <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,   <span class="co"># Annual cost, slight variation for simulation</span></span>
<span>  c_S1          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">4000</span>, sd <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,  <span class="co"># Higher annual cost, slightly varied</span></span>
<span>  c_S2          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">15000</span>, sd <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>, <span class="co"># Large cost with moderate variation</span></span>
<span>  c_D           <span class="op">=</span> <span class="fl">0</span>,                                        <span class="co"># Constant, no variation</span></span>
<span>  c_trtA        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">12000</span>, sd <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>, <span class="co"># Cost of treatment A with small variation</span></span>
<span>  c_trtB        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">13000</span>, sd <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>, <span class="co"># Cost of treatment B</span></span>
<span></span>
<span>  u_H           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span>,                  <span class="co"># Utility close to 1 for Healthy</span></span>
<span>  u_S1          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">7.5</span>, <span class="fl">2.5</span><span class="op">)</span>,               <span class="co"># Utility less than Healthy, beta distribution</span></span>
<span>  u_S2          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,                   <span class="co"># Utility for Sicker</span></span>
<span>  u_D           <span class="op">=</span> <span class="fl">0</span>,                                        <span class="co"># Utility for Dead is constant</span></span>
<span>  u_trtA        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">9.5</span>, <span class="fl">1</span><span class="op">)</span>,                 <span class="co"># Utility with treatment A, close to Healthy</span></span>
<span></span>
<span>  du_HS1        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">0.01</span>, sd <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span>, <span class="co"># Disutility with slight variation</span></span>
<span>  ic_HS1        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">1000</span>, sd <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,   <span class="co"># Cost increase with transition</span></span>
<span>  ic_D          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_sims</span>, mean <span class="op">=</span> <span class="fl">2000</span>, sd <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,    <span class="co"># Cost increase when dying</span></span>
<span>  p0_H          <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">rbeta</a></span><span class="op">(</span><span class="va">n_sims</span>, <span class="fl">1</span>, <span class="fl">9</span><span class="op">)</span>                   <span class="co"># Initial probability of being Healthy</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="probability-and-payoff-functions">Probability and Payoff Functions<a class="anchor" aria-label="anchor" href="#probability-and-payoff-functions"></a>
</h2>
<p>Then, we define the probability and payoff functions used in the
<code>twig</code> above:</p>
<div class="section level3">
<h3 id="probability-of-recovery">Probability of recovery<a class="anchor" aria-label="anchor" href="#probability-of-recovery"></a>
</h3>
<p>only those who are in S1 can recover</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pRecover</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">r_S1H</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">rRecover</span> <span class="op">&lt;-</span> <span class="va">r_S1H</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S1"</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="../reference/rate2prob.html">rate2prob</a></span><span class="op">(</span><span class="va">rRecover</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="probability-of-getting-sick">Probability of getting sick<a class="anchor" aria-label="anchor" href="#probability-of-getting-sick"></a>
</h3>
<p>Only those who are H can get sick</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pGetSick</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">r_HS1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">rGetSick</span> <span class="op">&lt;-</span> <span class="va">r_HS1</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"H"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/rate2prob.html">rate2prob</a></span><span class="op">(</span><span class="va">rGetSick</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="probability-of-progressing">probability of progressing<a class="anchor" aria-label="anchor" href="#probability-of-progressing"></a>
</h3>
<p>This depends on the state (only those who are in S1 can progress),
the decision (different rates for different decisions), and the
cycle_in_state (number of cycles spent in a state - tunnel state)</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pProgress</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">decision</span>, <span class="va">cycle_in_state</span>,</span>
<span>                      <span class="va">hr_S1S2_trtB</span>, <span class="va">r_S1S2_scale</span>, <span class="va">r_S1S2_shape</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">hr_S1S2</span> <span class="op">&lt;-</span> <span class="va">hr_S1S2_trtB</span> <span class="op">^</span> <span class="op">(</span><span class="va">decision</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"StrategyB"</span>, <span class="st">"StrategyAB"</span><span class="op">)</span><span class="op">)</span> <span class="co"># hazard rate of progression for B or 1 otherwise</span></span>
<span></span>
<span>  <span class="va">r_S1S2_tunnels</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="va">cycle_in_state</span><span class="op">*</span><span class="va">r_S1S2_scale</span><span class="op">)</span><span class="op">^</span><span class="va">r_S1S2_shape</span> <span class="op">-</span> </span>
<span>    <span class="op">(</span><span class="op">(</span><span class="va">cycle_in_state</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">r_S1S2_scale</span><span class="op">)</span><span class="op">^</span><span class="va">r_S1S2_shape</span><span class="op">)</span> <span class="co"># hazard rate based on cycle_in_state (tunnel) which follows a weibull distribution</span></span>
<span></span>
<span>  <span class="co"># only those who are at S1 can progress</span></span>
<span>  <span class="va">rProgress</span> <span class="op">&lt;-</span> <span class="va">r_S1S2_tunnels</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S1"</span><span class="op">)</span> <span class="op">*</span> <span class="va">hr_S1S2</span> </span>
<span></span>
<span>  <span class="fu"><a href="../reference/rate2prob.html">rate2prob</a></span><span class="op">(</span><span class="va">rProgress</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="probability-of-dying">probability of dying<a class="anchor" aria-label="anchor" href="#probability-of-dying"></a>
</h3>
<p>Probabilty of dying depends on age. So, we define age-specific
mortality data from the 2015 US Life Tables for ages 24 through 1000.
Then, we define the <code>pDie</code> as a function of the state
(different states have different rates of death), and the cycles since
the simulation start which reflects the cohort’s age.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">v_r_mort_by_age</span> <span class="op">&lt;-</span> <span class="va">vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fl">0.000979</span>, <span class="fl">0.001014</span>, <span class="fl">0.000999</span>, <span class="fl">0.001070</span>, <span class="fl">0.001087</span>, <span class="fl">0.001162</span>, <span class="fl">0.001167</span>, <span class="fl">0.001213</span>, <span class="fl">0.001289</span>, </span>
<span>  <span class="fl">0.001331</span>, <span class="fl">0.001375</span>, <span class="fl">0.001420</span>, <span class="fl">0.001490</span>, <span class="fl">0.001550</span>, <span class="fl">0.001616</span>, <span class="fl">0.001657</span>, <span class="fl">0.001747</span>, <span class="fl">0.001902</span>, </span>
<span>  <span class="fl">0.002052</span>, <span class="fl">0.002173</span>, <span class="fl">0.002395</span>, <span class="fl">0.002559</span>, <span class="fl">0.002807</span>, <span class="fl">0.003023</span>, <span class="fl">0.003349</span>, <span class="fl">0.003712</span>, <span class="fl">0.004085</span>, </span>
<span>  <span class="fl">0.004490</span>, <span class="fl">0.004905</span>, <span class="fl">0.005364</span>, <span class="fl">0.005806</span>, <span class="fl">0.006253</span>, <span class="fl">0.006775</span>, <span class="fl">0.007395</span>, <span class="fl">0.007895</span>, <span class="fl">0.008418</span>, </span>
<span>  <span class="fl">0.008974</span>, <span class="fl">0.009666</span>, <span class="fl">0.010456</span>, <span class="fl">0.011384</span>, <span class="fl">0.011838</span>, <span class="fl">0.012667</span>, <span class="fl">0.013593</span>, <span class="fl">0.014700</span>, <span class="fl">0.015732</span>, </span>
<span>  <span class="fl">0.017340</span>, <span class="fl">0.018758</span>, <span class="fl">0.020967</span>, <span class="fl">0.022917</span>, <span class="fl">0.024913</span>, <span class="fl">0.026767</span>, <span class="fl">0.029707</span>, <span class="fl">0.032412</span>, <span class="fl">0.035982</span>, </span>
<span>  <span class="fl">0.039238</span>, <span class="fl">0.043595</span>, <span class="fl">0.048727</span>, <span class="fl">0.053735</span>, <span class="fl">0.059911</span>, <span class="fl">0.066618</span>, <span class="fl">0.074051</span>, <span class="fl">0.082190</span>, <span class="fl">0.090754</span>, </span>
<span>  <span class="fl">0.103968</span>, <span class="fl">0.115093</span>, <span class="fl">0.124341</span>, <span class="fl">0.137872</span>, <span class="fl">0.154177</span>, <span class="fl">0.172393</span>, <span class="fl">0.194100</span>, <span class="fl">0.212654</span>, <span class="fl">0.243752</span>, </span>
<span>  <span class="fl">0.259087</span>, <span class="fl">0.287781</span>, <span class="fl">0.316429</span>, <span class="fl">0.339149</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># death depends on the state and age.</span></span>
<span><span class="va">pDie</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">cycle</span>,</span>
<span>                 <span class="va">hr_S1</span>, <span class="va">hr_S2</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">r_HD</span> <span class="op">&lt;-</span> <span class="va">v_r_mort_by_age</span><span class="op">[</span><span class="va">cycle</span><span class="op">]</span> <span class="co"># get age-specific mortality </span></span>
<span>  <span class="va">rDie</span> <span class="op">&lt;-</span> <span class="va">r_HD</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"H"</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># baseline mortality if healthy</span></span>
<span>          <span class="va">r_HD</span><span class="op">*</span><span class="va">hr_S1</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S1"</span><span class="op">)</span> <span class="op">+</span>  <span class="co"># multiplied by a hazard rate if S1 or </span></span>
<span>          <span class="va">r_HD</span><span class="op">*</span><span class="va">hr_S2</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S2"</span><span class="op">)</span> <span class="co"># S2</span></span>
<span>          <span class="co"># else 0</span></span>
<span>  <span class="fu"><a href="../reference/rate2prob.html">rate2prob</a></span><span class="op">(</span><span class="va">rDie</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cost">Cost<a class="anchor" aria-label="anchor" href="#cost"></a>
</h3>
<p>Cost is a function of the state, decision and whether either event
have occured. The events capture transition costs.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cost</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">decision</span>, <span class="va">second_event</span>, <span class="va">death_event</span>, </span>
<span>                 <span class="va">ic_HS1</span>, <span class="va">ic_D</span>, <span class="va">c_trtA</span>, <span class="va">c_trtB</span>, </span>
<span>                 <span class="va">c_H</span>, <span class="va">c_S1</span>, <span class="va">c_S2</span>, <span class="va">c_D</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># cost of decision is only applied if the state is either S1 or S2</span></span>
<span>  <span class="va">trans_cost_getting_sick</span> <span class="op">&lt;-</span> <span class="va">ic_HS1</span> <span class="op">*</span> <span class="op">(</span><span class="va">second_event</span><span class="op">==</span><span class="st">"getsick"</span><span class="op">)</span> <span class="co"># increase in cost when transitioning from Healthy to Sick</span></span>
<span>  <span class="va">trans_cost_dying</span> <span class="op">&lt;-</span> <span class="va">ic_D</span> <span class="op">*</span> <span class="op">(</span><span class="va">death_event</span><span class="op">==</span><span class="st">"yes"</span><span class="op">)</span> <span class="co"># increase in cost when dying</span></span>
<span>  </span>
<span>  <span class="va">c_decision</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">state</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"S1"</span>,<span class="st">"S2"</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span></span>
<span>      <span class="va">c_trtA</span> <span class="op">*</span> <span class="op">(</span><span class="va">decision</span><span class="op">==</span><span class="st">"StrategyA"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="va">c_trtB</span> <span class="op">*</span> <span class="op">(</span><span class="va">decision</span><span class="op">==</span><span class="st">"StrategyB"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="op">(</span><span class="va">c_trtA</span> <span class="op">+</span> <span class="va">c_trtB</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">decision</span><span class="op">==</span><span class="st">"StrategyAB"</span><span class="op">)</span> </span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># cost of the state is a function of the state</span></span>
<span>  <span class="va">c_state</span> <span class="op">&lt;-</span> <span class="va">c_H</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"H"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">c_S1</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S1"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">c_S2</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S2"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">c_D</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"D"</span><span class="op">)</span> </span>
<span>  <span class="co"># combine both</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">c_decision</span> <span class="op">+</span> <span class="va">c_state</span> <span class="op">+</span> <span class="va">trans_cost_getting_sick</span> <span class="op">+</span> <span class="va">trans_cost_dying</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="utility">Utility<a class="anchor" aria-label="anchor" href="#utility"></a>
</h3>
<p>Similarly, utility depends on the state, decision and only if the
cohort gotsick to apply a transition utility discount for those who make
that transition.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">utility</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span>, <span class="va">decision</span>, <span class="va">second_event</span>,</span>
<span>                    <span class="va">du_HS1</span>, <span class="va">u_H</span>, <span class="va">u_trtA</span>, <span class="va">u_S1</span>, <span class="va">u_S2</span>, <span class="va">u_D</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">trans_util_getting_sick</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">du_HS1</span> <span class="op">*</span> <span class="op">(</span><span class="va">second_event</span><span class="op">==</span><span class="st">"getsick"</span><span class="op">)</span> <span class="co"># apply a utility discount for those who get sick.</span></span>
<span></span>
<span>  <span class="co"># calcualte state utilities. note that S1 will have utility u_trtA if the decision involves A, and another utility if the decision does not involve A.</span></span>
<span>  <span class="va">u_state</span> <span class="op">&lt;-</span> <span class="va">u_H</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"H"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">u_trtA</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S1"</span> <span class="op">&amp;</span> <span class="va">decision</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"StrategyA"</span>, <span class="st">"StrategyAB"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>             <span class="va">u_S1</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S1"</span> <span class="op">&amp;</span> <span class="va">decision</span> <span class="op"><a href="../reference/grapes-out-grapes.html">%out%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"StrategyA"</span>, <span class="st">"StrategyAB"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">u_S2</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"S2"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>             <span class="va">u_D</span> <span class="op">*</span> <span class="op">(</span><span class="va">state</span><span class="op">==</span><span class="st">"D"</span><span class="op">)</span> </span>
<span></span>
<span>  <span class="co"># combine the two utilities.</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">u_state</span> <span class="op">+</span> <span class="va">trans_util_getting_sick</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="running-the-twig">Running the <code>twig</code><a class="anchor" aria-label="anchor" href="#running-the-twig"></a>
</h2>
<p>We can run the model and check the summary results under
<code>results$mean_ev</code> of average costs and utilities across all
probabilistic analyses. The results also returns the individual
simulation results under <code>results$sim_ev</code></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_twig.html">run_twig</a></span><span class="op">(</span>twig_obj <span class="op">=</span> <span class="va">mytwig</span>, params <span class="op">=</span> <span class="va">params</span>, n_cycles <span class="op">=</span> <span class="va">n_cycles</span>, progress_bar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Checking Twig syntax ....</span></span>
<span><span class="co">#&gt; Twig syntax validation completed successfully.</span></span>
<span><span class="co">#&gt; Preprocessing started...</span></span>
<span><span class="co">#&gt; Preprocessing completed. Starting simulation...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Total time: 4.4 secs</span></span>
<span></span>
<span><span class="va">results</span><span class="op">$</span><span class="va">mean_ev</span></span>
<span><span class="co">#&gt;                 payoff</span></span>
<span><span class="co">#&gt; decision              cost  utility</span></span>
<span><span class="co">#&gt;   StandardOfCare  80161.74 13.95844</span></span>
<span><span class="co">#&gt;   StrategyA      152013.97 14.44080</span></span>
<span><span class="co">#&gt;   StrategyB      140915.32 14.34537</span></span>
<span><span class="co">#&gt;   StrategyAB     206832.28 14.89491</span></span></code></pre></div>
<div class="section level3">
<h3 id="parallelization">Parallelization<a class="anchor" aria-label="anchor" href="#parallelization"></a>
</h3>
<p>You can run the same command with parallelization, by setting
<code>parallel = TRUE</code>. This will speed up the simulation by
running each simulation in parallel. [It is commented out here because
testing of the <code>twig</code> package only runs on a single
core.]</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># results &lt;- run_twig(twig_obj = mytwig, params = params, n_cycles = n_cycles, parallel = TRUE)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="incremental-cost-effectiveness-ratio-icer">Incremental Cost-Effectiveness Ratio (ICER)<a class="anchor" aria-label="anchor" href="#incremental-cost-effectiveness-ratio-icer"></a>
</h3>
<p>using the <code>calculate_icers</code> function adapted from the
dampack package, we can retrieve ICER table by passing the payoffs
summary table.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calculate_icers.html">calculate_icers</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">mean_ev</span><span class="op">)</span></span>
<span><span class="co">#&gt;                      decision      cost  utility inc_cost inc_utility   ICER</span></span>
<span><span class="co">#&gt; StandardOfCare StandardOfCare  80161.74 13.95844       NA          NA     NA</span></span>
<span><span class="co">#&gt; StrategyB           StrategyB 140915.32 14.34537       NA          NA     NA</span></span>
<span><span class="co">#&gt; StrategyA           StrategyA 152013.97 14.44080       NA          NA     NA</span></span>
<span><span class="co">#&gt; StrategyAB         StrategyAB 206832.28 14.89491 126670.5   0.9364688 135264</span></span>
<span><span class="co">#&gt;                status</span></span>
<span><span class="co">#&gt; StandardOfCare     ND</span></span>
<span><span class="co">#&gt; StrategyB          ED</span></span>
<span><span class="co">#&gt; StrategyA          ED</span></span>
<span><span class="co">#&gt; StrategyAB         ND</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cost-effectiveness-acceptibility-curve-ceac">Cost-Effectiveness Acceptibility Curve (CEAC)<a class="anchor" aria-label="anchor" href="#cost-effectiveness-acceptibility-curve-ceac"></a>
</h3>
<p>Similarly, we can produce the CEAC curve from the simulation results
and specifying a series of willingness to pay (WTP) values.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_ceac.html">plot_ceac</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">sim_ev</span>, wtp_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100000</span>, by <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="markov_time_dep_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h3>
<p>This example illustrated the following features of <code>twig</code>
* Markov model * probabilistic anslysis * Multiple decisions * Multiple
states * Multiple sequential events * tunnel states * cycle-dependency *
dependency on prior events in a cycle * transition payoffs * using
parallel computations * expected payoffs across probabilistic analyses *
ICER * CEAC</p>
<p>In addition, various intermediate objects and computations can be
returned by enabling <code>verbose</code>. To reduce the size of the
returned results, this will only use the first PSA sample. For details
on these objects check the documentations.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://www.dashlab.ca" class="external-link">Hawre Jalal</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
